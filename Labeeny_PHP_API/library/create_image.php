<?php
//==============================================begin images 
function uploadImage($inputName, $uploadDir, $thumbnail_width, $image_width)
{
	$image = $_FILES[$inputName];

	//echo "error " . $image['name'] . $image['tmp_name'] . "end;";	
	$imagePath = '';
	$thumbnailPath = '';
	//	echo "before";
	// if a file is given
	if (trim($image['tmp_name']) != '') {
		$ext = substr(strrchr($image['name'], "."), 1); //$extensions[$image['type']];

		// generate a random new file name to avoid name conflict
		$imagePath = md5(rand() * time()) . ".$ext";

		list($width, $height, $type, $attr) = getimagesize($image['tmp_name']);

		// make sure the image width does not exceed the
		// maximum allowed width

		if ($width > $image_width) {
			//					echo "after";
			$result    = createThumbnail($image['tmp_name'], $uploadDir . $imagePath, $image_width);
			$imagePath = $result;
		} else {
			$result = move_uploaded_file($image['tmp_name'], $uploadDir . $imagePath);
		}

		if ($result) {
			// create thumbnail
			$thumbnailPath =  md5(rand() * time()) . ".$ext";
			$result = createThumbnail($uploadDir . $imagePath, $uploadDir . $thumbnailPath, $thumbnail_width);

			// create thumbnail failed, delete the image
			if (!$result) {
				unlink($uploadDir . $imagePath);
				$imagePath = $thumbnailPath = '';
			} else {
				$thumbnailPath = $result;
			}
		} else {
			// the product cannot be upload / resized
			$imagePath = $thumbnailPath = '';
		}
	}


	return array('image' => $imagePath, 'thumbnail' => $thumbnailPath);
}

function createThumbnail($srcFile, $destFile, $width, $quality = 75)
{
	$thumbnail = '';

	if (file_exists($srcFile)  && isset($destFile)) {
		$size        = getimagesize($srcFile);
		$w           = number_format($width, 0, ',', '');
		$h           = number_format(($size[1] / $size[0]) * $width, 0, ',', '');

		$thumbnail =  copyImage($srcFile, $destFile, $w, $h, $quality);
	}

	// return the thumbnail file name on sucess or blank on fail
	return basename($thumbnail);
}

/*
	Copy an image to a destination file. The destination
	image size will be $w X $h pixels
*/


function copyImage($srcFile, $destFile, $w, $h, $quality = 75)
{
	$tmpSrc     = pathinfo(strtolower($srcFile));
	$tmpDest    = pathinfo(strtolower($destFile));
	$size       = getimagesize($srcFile);

	if (
		$tmpDest['extension'] == "gif" || $tmpDest['extension'] == "jpg"
		|| $tmpDest['extension'] == "jpeg"
		|| $tmpDest['extension'] == "bmp" || $tmpDest['extension'] == "mpeg"
	) {
		$destFile  = substr_replace($destFile, 'jpg', -3);
		$dest      = imagecreatetruecolor($w, $h);
		imageantialias($dest, TRUE);
	} elseif ($tmpDest['extension'] == "png") {
		/*   $dest = imagecreatetruecolor($w, $h);
	   $white = imagecolorallocate($dest, 255, 255, 255); 
	   imagefill($dest,0,0,$white);
       imageantialias($dest, TRUE);*/

		$dest = imagecreatetruecolor($w, $h);
		$background = imagecolorallocate($dest, 255, 255, 255);
		imagecolortransparent($dest, $background);
		imagealphablending($dest, false);
		imagesavealpha($dest, true);
	} else {
		return false;
	}

	switch ($size[2]) {
		case 1:       //GIF
			$src = imagecreatefromgif($srcFile);
			break;
		case 2:       //JPEG
			$src = imagecreatefromjpeg($srcFile);
			break;
		case 3:       //PNG
			$src = imagecreatefrompng($srcFile);
			break;
		default:
			return false;
			break;
	}

	imagecopyresampled($dest, $src, 0, 0, 0, 0, $w, $h, $size[0], $size[1]);

	switch ($size[2]) {
		case 1:
		case 2:
			imagejpeg($dest, $destFile, $quality);
			break;
		case 3:
			imagepng($dest, $destFile);
	}
	return $destFile;
}
